<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITH-Hub - Backup</title>
    <style>
        :root { --primary: #007bff; --accent: #ffd700; --bg: #0f0f0f; --card: #1a1a1a; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .header { padding: 40px 20px; text-align: center; }
        .header h1 { font-size: 3rem; margin: 0; background: linear-gradient(45deg, #007bff, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Formulaire de Token */
        .token-box {
            background: var(--card); border: 1px solid #333; border-radius: 20px; 
            padding: 40px; text-align: center; max-width: 450px; width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .token-input {
            width: 100%; padding: 12px; background: #0b0b0b; border: 1px solid #444; 
            color: #00ff00; border-radius: 10px; margin: 20px 0; font-family: monospace;
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        .token-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 123, 255, 0.3); }

        /* Liste des DMs */
        .dm-container { width: 90%; max-width: 800px; margin-bottom: 50px; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; width: 100%; }
        
        .grid { display: grid; gap: 15px; width: 100%; }
        .dm-card {
            background: var(--card); padding: 15px 25px; border-radius: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid #333; transition: 0.3s;
        }
        .dm-card:hover { border-color: var(--primary); background: #222; }

        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #333; }
        .username { font-weight: bold; font-size: 1.1rem; }
        .channel-id { font-size: 0.75rem; color: #666; font-family: monospace; }

        /* Boutons */
        .btn {
            background: var(--primary); color: white; border: none; 
            padding: 10px 20px; border-radius: 30px; cursor: pointer; 
            font-weight: bold; transition: 0.3s; text-decoration: none;
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn-secondary { background: transparent; border: 1px solid #444; color: #888; padding: 8px 15px; font-size: 0.9rem; }
        .btn-secondary:hover { border-color: #ff5252; color: #ff5252; }

        .error-msg { color: #ff5252; background: rgba(255, 82, 82, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ITH-SAVE</h1>
        <p>Archiveur de conversations priv√©es</p>
    </div>

    {% if not dms %}
    <div class="token-box">
        <i style="font-size: 3rem; display: block; margin-bottom: 10px;">üîë</i>
        <h2 style="margin: 0;">Authentification</h2>
        <p style="color: #888;">Entrez votre token Discord pour commencer</p>
        
        {% if error %} <div class="error-msg">{{ error }}</div> {% endif %}

        <form action="/save/list" method="POST">
            <input type="password" name="token" class="token-input" placeholder="mfa.xxxxx..." required>
            <button type="submit" class="btn" style="width: 100%;">Charger les conversations</button>
        </form>
        <br>
        <a href="/hub" style="color: #666; text-decoration: none; font-size: 0.9rem;">‚¨Ö Retour au Hub</a>
    </div>

    {% else %}
    <div class="dm-container">
        <div class="list-header">
            <h3 style="margin: 0;">Conversations trouv√©es ({{ dms|length }})</h3>
            <a href="/save" class="btn btn-secondary">Changer de token</a>
        </div>

        <div class="grid">
            {% for dm in dms %}
            <div class="dm-card">
                <div class="user-info">
                    <img src="{{ dm.avatar }}" alt="avatar">
                    <div>
                        <div class="username">@{{ dm.username }}</div>
                        <div class="channel-id">Channel: {{ dm.channel_id }}</div>
                    </div>
                </div>
                <button onclick="startBackup(this, '{{ dm.channel_id }}')" class="btn">
                    üíæ Sauvegarder
                </button>
            </div>
            {% endfor %}
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <a href="/hub" style="color: #888; text-decoration: none;">Retour au menu principal</a>
        </div>
    </div>
    {% endif %}

    <script>
        function startBackup(btn, cid) {
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ G√©n√©ration...";
            btn.style.opacity = "0.7";
            btn.disabled = true;

            fetch('/save/run/' + cid, { method: 'POST' })
            .then(response => {
                if (response.ok) return response.blob();
                throw new Error('Erreur');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'backup_' + cid + '.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);

                btn.innerHTML = "‚úÖ Pr√™t !";
                btn.style.background = "var(--success)";
                btn.style.opacity = "1";
                setTimeout(() => { 
                    btn.innerHTML = originalText; 
                    btn.style.background = "var(--primary)";
                    btn.disabled = false;
                }, 3000);
            })
            .catch(error => {
                btn.innerHTML = "‚ùå Erreur";
                btn.style.background = "#ff5252";
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
